# Nonogram Solver - C++

A Nonogram solver in C++. See the Wikipeida [article][nonogram_wiki].

[nonogram_wiki]: https://en.wikipedia.org/wiki/Nonogram 

## Compile and run 

Requires the Visual Studio C++ developer tools, which can be installed with the Visual Studio Installer.

### Build with Visual Studio Code

1. In Developer Command Prompt for VS run `.` to open Visual Studio Code.
2. Confirm the Microsoft C++ tool (MSVC) is working by typing `cl` in the command prompt.
3. Run build task: Ctrl + Shift + B
4. Run with: `NonogramSolver.exe` in the cmd. For example `NonogramSolver --solve --filepath puzzles/lost.txt`.

### Build with the Developer Command Prompt for VS

In Developer Command Prompt for VS:
1. Set the directory with `set "fileDirname=C:\path\to\NonogramSolverCpp"`
2. Build with:
	```
	cl.exe /Zi /EHsc /nologo "/Fe%fileDirname%\\NonogramSolver.exe" "%fileDirname%\\*.cpp"
	```

### Clean up

Delete .obj, .exe, .ilk and .pdb files. This can be done with: `del *.obj *.ilk *.pdb`.

The NonogramSolver.exe can be run without these.

### Run 

In the cmd navigate to the folder with the NonogramSolver.exe and type `NonogramSolver`. Examples:
- `NonogramSolver --solve --file-path puzzles/lost.txt --to-file`
- `NonogramSolver --solve-collection --file-path collections/various.txt --print --guess`

## Algorithm 

### Fast solver

Based on ideas by [Jan Wolter][Wolter_survey] and [Steve Simpson][lancaster_solver].

Algorithm
- Do constraint propagation with row and column sweeps.
	- Find the left-most and right-most match for each row/column. This is done using a Nondeterministic Finite State Machine and Thompsons algorithm. This is an O(n^2) algorithm. See my blog [post][nfa_post] for more detail.
	- Find overlaps. This is done by finding a "changer sequence". See the example below. It is made by replacing each symbol with a counter which increments every time the symbols change e.g. from BLACK to WHITE. Counter values which are in the same index in both left and right matches are overlaps.
	- A simple filler which adds very simple clues that the left-right algorithm sometimes misses e.g. a white after ending a black sequence.
- If this fails, guess and then go back to constraint propagation.
	- First try to find contradictions -> guesses which are obviously wrong. This will happen if there are no matches for the line matcher. The opposite guess is therefore correct.
	- Otherwise save the current grid and make a binary guess. Backtrack if it is wrong. This is O(2^n), so it can very easily lead down a never ending spiral of guesses. 

<pre>
Example by [Steve Simpson][lancaster_fast]:	
Length:   24 
Rule:     1,1,5 
Original: >---#---------#-----#####< 
Broken:   >---#--         -      # < 
      left>000122344444444444555556< 
     right>000122222222222223455555< 
      fast>---#--+++++++++-+++####+< 
</pre>

[Wolter_survey]: https://webpbn.com/survey/
[lancaster_solver]: http://scc-forge.lancaster.ac.uk/open/nonogram/
[lancaster_fast]: http://scc-forge.lancaster.ac.uk/open/nonogram/ls-fast
[rosetta_code]: https://rosettacode.org/wiki/Nonogram_solver
[nfa_post]: https://liorsinai.github.io/coding/2020/10/29/finite-state-machines.html

## Input files

### Solve collection
Solve a collection of puzzles in a single file.

Format is:

---
<div>
General description (this line is skipped by the file reader) <br>
-- puzzle title (this line is skipped by the file reader)<br>
[run rows] <br>
[run cols] <br>
-- next puzzle title (this line is skipped by the file reader) <br>
... <br>
--- 
</div>

The runs are given by sets of unicode characters, with A=1, B=2 and so on. Spaces represent a new row/column.
This can work for a numbers greater than 26, but these will be encoded as non-Basic Latin unicode symbols.

### Solve puzzle
Based on Steve Simpsons .non format.

Format is:

---
<div>
text    (this line is skipped by the file reader) <br>
title  (this line is skipped by the file reader) <br>

width w (this line is skipped by the file reader) <br>
height h (this line is skipped by the file reader) <br>

rows  <br>
x, x, x <br>
.... <br>

columns <br>
x, x, x <br>
... <br>
</div>

---

## Example solutions
Elephant, 15x15, solved in 0.012s
<pre>
-  -  -  -  -  -  03 -  -  -  01 -  -  -  -  -  -  -  -   
-  -  -  -  -  -  03 07 -  -  05 02 -  -  01 01 01 01 -  
-  -  -  -  01 11 01 02 07 15 07 08 14 09 06 09 09 10 12 
-  -  -  03 .  .  .  .  .  #  #  #  .  .  .  .  .  .  . 
-  -  04 02 .  .  #  #  #  #  .  #  #  .  .  .  .  .  .   
-  -  06 06 .  #  #  #  #  #  #  .  #  #  #  #  #  #  . 
-  06 02 01 .  #  #  #  #  #  #  .  #  #  .  .  .  .  # 
01 04 02 01 .  #  .  #  #  #  #  .  #  #  .  .  .  .  # 
-  06 03 02 .  #  #  #  #  #  #  .  #  #  #  .  .  #  # 
-  -  06 07 .  #  #  #  #  #  #  .  #  #  #  #  #  #  # 
-  -  06 08 #  #  #  #  #  #  .  #  #  #  #  #  #  #  # 
-  -  01 10 .  #  .  .  .  #  #  #  #  #  #  #  #  #  # 
-  -  01 10 .  #  .  .  .  #  #  #  #  #  #  #  #  #  # 
-  -  01 10 .  #  .  .  .  #  #  #  #  #  #  #  #  #  # 
01 01 04 04 .  #  .  #  .  #  #  #  #  .  .  #  #  #  # 
-  03 04 04 .  #  #  #  .  #  #  #  #  .  .  #  #  #  # 
-  -  04 04 .  .  .  .  .  #  #  #  #  .  .  #  #  #  #   
-  -  04 04 .  .  .  .  .  #  #  #  #  .  .  #  #  #  # 
</pre>

"Where there is smoke", solved in 0.154s with 12 guesses:
<div>
<pre>
- -  -  -  -  -  -  -  -  -  -  01 -  -  -  -  -  -  -  -  -  -  -  -  -  - 
- -  -  -  -  -  -  -  03 -  -  01 02 -  03 -  -  -  -  -  -  -  -  -  -  - 
- -  -  -  -  -  -  01 03 -  01 01 01 02 01 01 -  -  -  -  -  03 -  -  -  - 
- -  -  -  -  -  02 06 01 -  03 02 01 04 02 04 03 02 -  -  -  02 03 -  -  01 
- -  -  -  -  -  02 04 01 02 03 01 01 03 03 02 01 01 03 07 05 01 04 09 08 08 
- -  -  -  -  -  01 04 04 02 03 02 01 03 01 01 02 01 03 04 04 03 01 02 03 02 
- -  01 03 02 01 .  #  .  #  #  #  .  .  #  #  .  .  .  .  .  .  .  .  .  #
- -  -  01 02 02 #  .  #  #  .  .  .  #  #  .  .  .  .  .  .  .  .  .  .  .
- -  -  -  03 04 #  #  #  .  .  .  #  #  #  #  .  .  .  .  .  .  .  .  .  .
- -  -  02 03 02 .  #  #  .  #  #  #  .  .  #  #  .  .  .  .  .  .  .  .  .
- -  -  02 01 06 #  #  .  .  #  .  .  .  .  #  #  #  #  #  #  .  .  .  .  .
- -  -  02 13 01 #  #  .  .  #  #  #  #  #  #  #  #  #  #  #  #  #  .  .  #
- -  -  01 01 08 .  #  .  .  .  .  .  #  .  .  .  .  #  #  #  #  #  #  #  #
- -  02 01 01 07 .  #  #  .  .  .  .  #  .  #  .  .  .  #  #  #  #  #  #  #
- 01 02 02 02 03 .  .  #  .  .  .  #  #  .  #  #  .  .  #  #  .  .  #  #  #
- 03 01 01 01 03 #  #  #  .  .  #  .  .  .  .  .  .  .  #  .  #  .  #  #  #
- 01 02 01 01 03 .  #  .  .  #  #  .  .  .  .  .  .  .  #  .  #  .  #  #  #
- -  02 01 01 03 .  #  #  .  #  .  .  .  #  .  .  .  .  .  .  .  .  #  #  #
- -  -  01 05 05 .  #  .  .  #  #  #  #  #  .  .  .  .  .  .  #  #  #  #  #
- -  -  01 01 03 .  .  #  .  .  .  .  #  .  .  .  .  .  .  .  .  #  #  #  .
- -  -  -  04 02 .  .  .  .  .  #  #  #  #  .  .  .  .  .  .  .  #  #  .  .
- 02 02 01 02 01 .  #  #  .  #  #  .  .  #  .  .  .  .  .  .  #  #  .  .  #
- 02 01 02 03 02 .  #  #  .  #  .  .  #  #  .  .  .  .  #  #  #  .  .  #  #
- -  04 01 06 01 .  #  #  #  #  .  .  #  .  .  #  #  #  #  #  #  .  .  #  .
- -  03 04 03 02 .  #  #  #  .  .  .  #  #  #  #  .  #  #  #  .  .  #  #  .
- -  -  -  04 02 .  .  .  .  .  .  .  .  .  .  .  #  #  #  #  .  #  #  .  .
</pre>
</div>


Lost, 78x78, solved in 1.6s:
<div>
<pre>
- # . . # # # . . . # # . # # . . . # # # . # # . # # . # # . . # # . # # # . # # . . # # # . # # # . # # # . . # # # . # # . # # # . . # # . . . # # . # # #
- # . # # . # # # . . # # # . # # . # # # . # # . . # # # . # # . # # # . . . # # . # # . . # # # . # # . . . # # . # # # . # # # . # # # . # # # . . # # # .
- . . . . # # . # # # . # # . # # . . . # # # . # # . . # # . . # # . # # . # # . # # # . . # # . . # # . # # # . # # . . . # # . # # . # # . . # # . . # . #
- # # # . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . # #
- # # # . # . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . # # # # #
- # . . . # . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . # . # # .
- . # # . # . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . # # # # . . . . . . . . . . . . . . . . . . . . . . . . . . . . . # . # . .
- # # # . # . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . . # . . . #
- # . . # # . . . . . . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # #
- . # # # # . . . . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # .
- . # # # # . . . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # . #
- # . # . # . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # . # # # # # # . . . . . . . . . . . . . . . . . . . . . # . . # #
- # # . # # . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # . . . # # # # # # # . . . . . . . . . . . . . . . . . . . # # # # #
- # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # . . # # # # # # # . . . . . . . . . . . . . . . . . . . # # # . .
- . # # . # . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . # # # # #
- # . . # # # # # # . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . # . . # #
- # . . # # # # # # # . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . # # # . .
- . . # # # # # # # # # . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . # # # # .
- . # # . . # # # # # # # # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . # # . # #
- # # . # # # # # # # # # # # . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . # . . . #
- # # # # # # # # # # # # # # # # # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . # . # . #
- . . # . . . . # # # # # # # # # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . # # # # .
- . # . # . . . . . # # # # # # # # # # . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . # # # # #
- # # . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . # . . . #
- # # # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . # # # . #
- . . # . # . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . # # # # .
- # # # # # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . # # # # # . . . . . . . # # # # #
- # # . # # . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . # # # # # . . . . . . . # . . # #
- . . # . # . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . # # # # # # . . . . . . # # # . #
- # # # . # . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . # # # # # # # . . . . . # # # # .
- # # # # # . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . # # # # # # # # . . . . # . # # .
- . . . # # . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . # # # # # # # # # # # # # . . . #
- # # # . # . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . # # # # # # # # # # # . # . # . #
- # # # # # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . # # # # # # # # . . . . # # # . #
- . # . # # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . # # # # # # # # # . . . . # # . # .
- . . . # # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # . # . # # #
- . # . . # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # # # # . . . . . . # # # . #
- # # # . # . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . # # # . . . . . . . . # # # # # # # # # . . . . . . . # # . # .
- # # # # # . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . # # . . . . . . . . . # # # # # # # . . . . . . . # . . # .
- . . . # # . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # . . . # # # . .
- . . # . # . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . # . . # # # # # # # # # # # . . . # # # . #
- # # # # # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . # # # . . . . . . . . # # # . # # # # # # # # # # # # # # # . . . #
- # # . # # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # . . . . . # # # # .
- . . . . # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # . . . . . # # # # #
- # # . . # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # . . . . . . # . . # #
- # # . # # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # . . . . # # . # . #
- . # # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # . . . . # . # # # .
- # . # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # . . . . # # # . # #
- # . # . # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # . . . . . . # # . # . #
- . # . # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . . . # # # # # # # . . . . . . # # . # # #
- . # # # # . . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . # # # . . . . . # # # # # # # # # . . . . # # # # . # .
- # # # . # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . # # . . . # # # # # # # # # # # . . . # # # # # . #
- # . . . # # . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . # . . . . # # # # # # # # # # # # # # # # # . # . #
- # # # # # # . . # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # .
- . # # # # # . . . # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # . # .
- # # # . # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . # # # # # # # # # . # # # # # # # # # # # # # # # # # # # # . . #
- # . . # # . . . . . # # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . # # # # . . . # # # # # # # # # # # # # # # # # # # . . . #
- # # # # # . . . . . . # # # # # # # # # # # # # # # # # # # # # # . . . # . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # . # # .
- . # # # # . . . . . . . . # # # # # # # # # # # # # # # # # # # # . . . . # . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # #
- # . . . # # . . . . . . . # # # # # # # # # # # # # # # # # # # . . . . # # . . . . . . . . . . . # # # . # # # # # # # # # # # # # # # # # # # # # # # . #
- # . # # # . . . . . . . # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # . . # #
- # # # # # . . . . . . . # # # # # # # # # # # # # # # # # # # . . . . . . . . # # . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # .
- . # # # # . . . . . . # # # # # # # # # # # # # # # # # # # # . . . . . . . . # # # # . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # . .
- . # . . # # # . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # #
- # . # . # # # . . # # # # # # # # # # # # # # # # # # # # # # . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . # #
- # # # # # # . . # # # # # # # # # # # # # # # # # # . . . # # # . . . . . . . . . . # # # . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # . #
- . # . # # . . . # # # # # # # # # # # # # # # # # . . . . # # . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . .
- # # . # # # . . # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # . # # .
- # . # . # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . . . . . . # # # . . . # # # # # # # # # # # # # # # # # # # . . . . # #
- . # # # # # # # # # # # # # # # # # # # # # # # . . . . . . . . . . . . . . . . . # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . # #
- # # . # # # # # # # # # # # # # # # # # # # # # . . . . . # # . . . . . . . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . #
- # # . . # # # # # # # # # # # # # # # # # # # # . . . . . # # # # # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . .
- . . # . # # # # # # # # # # # # # # # # # # # # . . . . # # # # # # # # . . . . # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # . . # .
- # . # . # # . # # # . # # . . # # . . # # . # # . # # . # # . . . # # # . # # # . . # # # . # # # . # # # . . # # . # # # . # # . . # # . # # # . # # # # #
</pre>
</div>
